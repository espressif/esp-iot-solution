## ELF console Example

This example shows how to dynamic load shared object or ELF application from file-system and execute it.

## How to Use Example

Before project configuration and build, be sure to set the correct chip target using `idf.py set-target <chip_name>`.

* Note: Only ESP32, ESP32-S2, ESP32-S3, ESP32-C6 and ESP32-P4 are supported

### Hardware Required

* A development board based on espressif ESP32/ESP32-S2/ESP32-S3/ESP32-C6/ESP32-P4 SoC
* A USB cable for power supply and programming

### Configure the Project

Open the project configuration menu (`idf.py menuconfig`).

In the `Example Configuration` menu:

* Enable shell command in the `Enable ELF shell command` option.

### Generate the ELF File

The `main/fs_image/xtensa/test_app.elf` or `main/fs_image/xtensa/test_so.elf` used for testing is corresponding ELF file generated by [build_elf_file_example](https://github.com/espressif/esp-iot-solution/tree/master/examples/elf_loader/build_elf_file_example), corresponding to the `xtensa` and `risc-v` processor architectures respectively.

In `build_elf_file_example` example, `hello_world.app.elf` will be generated, and you can copy this ELF file to the `elf_loader_example/main`, e.g.
```
    cp build/hello_world.app.elf ../elf_console_example/main/fs_image/xtensa/test_app.elf
```

You can refer to [build_elf_file_example](https://github.com/espressif/esp-iot-solution/tree/master/examples/elf_loader/build_elf_file_example) to generate the ELF file you need.

### Build and Flash

Run `idf.py -p PORT flash monitor` to build, flash and monitor the project.

(To exit the serial monitor, type ``Ctrl-]``.)

### Command Line Tool

The supported commands are as follows:

#### ls

Display the files in the target directory by running the following command:

```
ls <file_or_directory>

    file_or_directory: directory name with full path
```

#### free

Display memory heap information, including total, used, and remaining heap size. When PSRAM is enabled, it also can show DRAM and PSRAM memory heap information respectively. The reference command is as follows:

```
free
```

#### insmod

Dynamic Load shared objects from the file system into memory:

```
insmod <file>

    file: shared objects file name with full path
```

#### rmmod

Remove a previously installed shared objects from memory:

```
rmmod <file>

    file: shared objects file name with full path
```

#### list

List dynamic load shared objects:

```
list [Configuration parameters]
```

The relevant configuration parameters are described as follows:

```
    -m/--shared modules: Dynamic load a list of shared object modules
    -s/--symbols table: Symbols table in shared object
```

#### exec

Dynamic load shared object or ELF application from file-system and execute it:

```
exec [Configuration parameters] <file>

    file: WebAssembly application file name with full path
```

The relevant configuration parameters are described as follows:

```
    -s/--shared object: Execute functions in dynamic load shared objects
    -e/--symbols table: Execute a ELF application
```

## Example Output

#### Execute a ELF application

The reference command is as follows:

```sh
ELF> exec -e xtensa/test_app.elf
```
You will see the following log:

```
Open file:xtensa/test_app.elf, len=1220
I (2952006) ELF: ELF loader version: 1.1.0
Start to relocate ELF file
I (2952006) ELF: elf->entry=0x4008e1cc
hello world 0
hello world 1
hello world 2
hello world 3
hello world 4
hello world 5
hello world 6
hello world 7
hello world 8
hello world 9
Success to exit from ELF file
```

#### Execute functions in dynamic load shared objects

The reference command is as follows:

```sh
ELF> exec -s xtensa/lib.so
```

You will see the following log:

```
I (3183756) ELF: ELF loader version: 1.1.0
I (3183756) ELF: elf->entry=0x4008df48
I (3183756) ELF: elf->symtab[0], func: fibonacci
I (3183766) ELF: elf->symtab[1], func: try_test
hello world 0
hello world 1
hello world 2
hello world 3
hello world 4
hello world 5
hello world 6
hello world 7
hello world 8
hello world 9
fibonacci(10) test
Fibonacci number at position 10 is 55
I (3193766) DLMOD: Removed node with name: lib.so
```

#### Execute a ELF application (the ELF application depends on shared files)

The reference command is as follows:

```sh
ELF> insmod xtensa/lib.so
```

You will see the following log:

```
I (3343606) ELF: ELF loader version: 1.1.0
I (3343606) ELF: elf->entry=0x4008df48
I (3343606) ELF: elf->symtab[0], func: fibonacci
I (3343626) ELF: elf->symtab[1], func: try_test
```

```sh
ELF> exec -e xtensa/test_so.elf
```

You will see the following log:

```
Open file:xtensa/test_so.elf, len=1336
I (3567126) ELF: ELF loader version: 1.1.0
Start to relocate ELF file
I (3567136) ELF: elf->entry=0x4008e2b8
hello world 0
hello world 1
hello world 2
hello world 3
hello world 4
hello world 5
hello world 6
hello world 7
hello world 8
hello world 9
fibonacci(10) test
Success to exit from ELF file
```