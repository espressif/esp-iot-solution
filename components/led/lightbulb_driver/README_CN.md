# çƒæ³¡ç¯ç»„ä»¶æ¦‚è¿°

ğŸ‘‰ [English Version](./README.md)

çƒæ³¡ç¯ç»„ä»¶å°†çƒæ³¡ç¯ä¸­å¸¸ç”¨çš„å¤šæ¬¾è°ƒå…‰æ–¹æ¡ˆåšäº†å°è£…ï¼Œä½¿ç”¨ä¸€ä¸ªæŠ½è±¡å±‚ç®¡ç†è¿™äº›æ–¹æ¡ˆï¼Œä¾¿äºå¼€å‘è€…é›†æˆåˆ°è‡ªå·±çš„åº”ç”¨ç¨‹åºä¸­ï¼Œç›®å‰æ‰€æœ‰ ESP32 ç³»åˆ—èŠ¯ç‰‡éƒ½å·²ç»å®Œæˆæ”¯æŒã€‚

## å·²æ”¯æŒçš„è°ƒå…‰æ–¹æ¡ˆå¦‚ä¸‹

- PWM æ–¹æ¡ˆ

  - RGB + C/W
  - RGB + CCT/Brightness

- IIC è°ƒå…‰èŠ¯ç‰‡æ–¹æ¡ˆ

  - ~~SM2135E~~
  - SM2135EH
  - SM2X35EGH (SM2235EGH/SM2335EGH)
  - BP57x8D (BP5758/BP5758D/BP5768)
  - BP1658CJ
  - KP18058

- å•æ€»çº¿æ–¹æ¡ˆ

  - WS2812

## å·²æ”¯æŒçš„å¸¸ç”¨åŠŸèƒ½å¦‚ä¸‹

- åŠ¨æ•ˆï¼šæ”¯æŒä½¿ç”¨æ¸å˜åˆ‡æ¢å„ç§é¢œè‰²ï¼Œæ”¯æŒé…ç½®å‘¨æœŸæ€§çš„å‘¼å¸åŠé—ªçƒæ•ˆæœ
- æ ¡å‡†ï¼šæ”¯æŒä½¿ç”¨ç³»æ•°å¾®è°ƒè¾“å‡ºæ•°æ®å®ç°ç™½å¹³è¡¡åŠŸèƒ½ï¼Œæ”¯æŒä½¿ç”¨ gamma æ ¡å‡†æ›²çº¿
- çŠ¶æ€å­˜å‚¨ï¼šä½¿ç”¨ `NVS` ç»„ä»¶å­˜å‚¨çƒæ³¡ç¯å½“å‰çŠ¶æ€ï¼Œæ–¹ä¾¿å®ç°æ–­ç”µè®°å¿†ç­‰åŠŸèƒ½
- ç¯ç é…ç½®ï¼šæ”¯æŒæœ€å¤š 5 ç§ç¯ç ï¼Œå¯é…ç½®çš„ç»„åˆå¦‚ä¸‹ï¼š
  - å•è·¯ï¼Œå†·æˆ–æš–è‰²æ¸©ç¯ç ï¼Œå¯ä»¥å®Œæˆå•è‰²æ¸©ä¸‹çš„äº®åº¦æ§åˆ¶
  - åŒè·¯ï¼Œå†·æš–ç¯ç ï¼Œå¯ä»¥å®Œæˆè‰²æ¸©ä¸äº®åº¦çš„æ§åˆ¶
  - ä¸‰è·¯ï¼Œçº¢è‰²ã€ç»¿è‰²ã€è“è‰²ç¯ç ï¼Œå¯ä»¥å®Œæˆä»»æ„é¢œè‰²æ§åˆ¶
  - å››è·¯ï¼Œçº¢è‰²ã€ç»¿è‰²ã€è“è‰²ã€å†·è‰²æˆ–æš–è‰²ç¯ç ï¼Œå¯ä»¥å®Œæˆé¢œè‰²ä¸å•ä¸€è‰²æ¸©ä¸‹çš„äº®åº¦æ§åˆ¶ï¼Œå¦‚æœé…ç½®äº†æ··è‰²è¡¨æ ¼ï¼Œåˆ™æ”¯æŒä½¿ç”¨è¿™äº›ç¯ç æ··å‡ºä¸åŒè‰²æ¸©ï¼Œå®ç°è‰²æ¸©æ§åˆ¶
  - äº”è·¯ï¼Œçº¢è‰²ã€ç»¿è‰²ã€è“è‰²ã€å†·è‰²ã€æš–è‰²ç¯ç ï¼Œå¯ä»¥å®Œæˆé¢œè‰²ä¸è‰²æ¸©ä¸‹çš„äº®åº¦æ§åˆ¶
- åŠŸç‡é™åˆ¶ï¼šå¹³è¡¡ä¸åŒè‰²æ¸©ï¼Œé¢œè‰²ä¸‹çš„è¾“å‡ºåŠŸç‡
- ä½åŠŸè€—ï¼šåœ¨ä¸å½±å“åŠ¨æ•ˆçš„æƒ…å†µä¸‹å‡å°‘æ•´ä½“åŠŸè€—
- è½¯ä»¶è‰²æ¸©ï¼šé€‚ç”¨äºä¸è¿›è¡Œç¡¬ä»¶è°ƒæ•´è‰²æ¸©çš„ PWM é©±åŠ¨

## PWM æ–¹æ¡ˆä½¿ç”¨ç¤ºä¾‹

PWM æ–¹æ¡ˆä½¿ç”¨ LEDC é©±åŠ¨å®ç°ï¼Œæ”¯æŒé…ç½®è½¯ä»¶/ç¡¬ä»¶æ¸å˜åŠŸèƒ½ï¼Œæ”¯æŒæ ¹æ®é¢‘ç‡è‡ªåŠ¨é…ç½®åˆ†è¾¨ç‡ï¼Œä½¿ç”¨å®ä¾‹å¦‚ä¸‹ï¼š

```c
lightbulb_config_t config = {
    //1. é€‰æ‹© PWM è¾“å‡ºå¹¶è¿›è¡Œå‚æ•°é…ç½®
    .type = DRIVER_ESP_PWM,
    .driver_conf.pwm.freq_hz = 4000,

    //2. åŠŸèƒ½é€‰æ‹©ï¼Œæ ¹æ®ä½ çš„éœ€è¦å¯ç”¨/ç¦ç”¨
    .capability.enable_fade = true,
    .capability.fade_time_ms = 800,
    .capability.enable_lowpower = false,
    /* å¦‚æœä½ çš„é©±åŠ¨ç™½å…‰è¾“å‡ºä¸ºç¡¬ä»¶å•ç‹¬æ§åˆ¶è€Œä¸æ˜¯è½¯ä»¶æ··è‰²ï¼Œéœ€è¦å¯ç”¨æ­¤åŠŸèƒ½ */
    .capability.enable_hardware_cct = true,
    .capability.enable_status_storage = true,
    /* ç”¨äºé…ç½® LED ç¯ç ç»„åˆ */
    .capability.led_beads = LED_BEADS_3CH_RGB,
    .capability.storage_cb = NULL,
    .capability.sync_change_brightness_value = true,

    //3. é…ç½® PWM è¾“å‡ºçš„ç¡¬ä»¶ç®¡è„š
    .io_conf.pwm_io.red = 25,
    .io_conf.pwm_io.green = 26,
    .io_conf.pwm_io.blue = 27,

    //4. é™åˆ¶å‚æ•°ï¼Œä½¿ç”¨ç»†åˆ™è¯·å‚è€ƒåé¢å°èŠ‚
    .external_limit = NULL,

    //5. é¢œè‰²æ ¡å‡†å‚æ•°
    .gamma_conf = NULL,

    //6. åˆå§‹åŒ–ç…§æ˜å‚æ•°ï¼Œå¦‚æœ on ç½®ä½å°†åœ¨åˆå§‹åŒ–é©±åŠ¨æ—¶ç‚¹äº®çƒæ³¡ç¯
    .init_status.mode = WORK_COLOR,
    .init_status.on = true,
    .init_status.hue = 0,
    .init_status.saturation = 100,
    .init_status.value = 100,
};
lightbulb_init(&config);
```

## IIC è°ƒå…‰èŠ¯ç‰‡æ–¹æ¡ˆä½¿ç”¨ç¤ºä¾‹

IIC è°ƒå…‰èŠ¯ç‰‡æ–¹æ¡ˆå·²æ”¯æŒé…ç½® IIC è°ƒå…‰èŠ¯ç‰‡çš„æ‰€æœ‰å‚æ•°ï¼Œè°ƒå…‰èŠ¯ç‰‡çš„å…·ä½“åŠŸèƒ½åŠå‚æ•°è¯·å‚é˜…æ‰‹å†Œå¡«å†™.ä½¿ç”¨å®ä¾‹å¦‚ä¸‹ï¼š

```c
lightbulb_config_t config = {
    //1. é€‰æ‹©éœ€è¦çš„èŠ¯ç‰‡å¹¶è¿›è¡Œå‚æ•°é…ç½®ï¼Œæ¯æ¬¾èŠ¯ç‰‡é…ç½®çš„å‚æ•°å­˜åœ¨ä¸åŒï¼Œè¯·ä»”ç»†å‚é˜…èŠ¯ç‰‡æ‰‹å†Œ
    .type = DRIVER_BP57x8D,
    .driver_conf.bp57x8d.freq_khz = 300,
    .driver_conf.bp57x8d.enable_iic_queue = true,
    .driver_conf.bp57x8d.iic_clk = 4,
    .driver_conf.bp57x8d.iic_sda = 5,
    .driver_conf.bp57x8d.current = {50, 50, 60, 30, 50},

    //2. é©±åŠ¨åŠŸèƒ½é€‰æ‹©ï¼Œæ ¹æ®ä½ çš„éœ€è¦å¯ç”¨/ç¦ç”¨
    .capability.enable_fade = true,
    .capability.fade_time_ms = 800,
    .capability.enable_lowpower = false,

    .capability.enable_status_storage = true,
    .capability.led_beads = LED_BEADS_5CH_RGBCW,
    .capability.storage_cb = NULL,
    .capability.sync_change_brightness_value = true,

    //3. é…ç½® IIC èŠ¯ç‰‡çš„ç¡¬ä»¶ç®¡è„š
    .io_conf.iic_io.red = OUT3,
    .io_conf.iic_io.green = OUT2,
    .io_conf.iic_io.blue = OUT1,
    .io_conf.iic_io.cold_white = OUT5,
    .io_conf.iic_io.warm_yellow = OUT4,

    //4. é™åˆ¶å‚æ•°ï¼Œä½¿ç”¨ç»†åˆ™è¯·å‚è€ƒåé¢å°èŠ‚
    .external_limit = NULL,

    //5. é¢œè‰²æ ¡å‡†å‚æ•°
    .gamma_conf = NULL,

    //6. åˆå§‹åŒ–ç…§æ˜å‚æ•°ï¼Œå¦‚æœ on ç½®ä½å°†åœ¨åˆå§‹åŒ–é©±åŠ¨æ—¶ç‚¹äº®çƒæ³¡ç¯
    .init_status.mode = WORK_COLOR,
    .init_status.on = true,
    .init_status.hue = 0,
    .init_status.saturation = 100,
    .init_status.value = 100,
};
lightbulb_init(&config);
```

## å•æ€»çº¿æ–¹æ¡ˆä½¿ç”¨ç¤ºä¾‹

å•æ€»çº¿æ–¹æ¡ˆä½¿ç”¨ SPI é©±åŠ¨è¾“å‡º WS2812 æ‰€éœ€è¦çš„æ•°æ®ï¼Œæ•°æ®å°è£…é¡ºåºä¸º GRBã€‚

```c
lightbulb_config_t config = {
    //1. é€‰æ‹© WS2812 è¾“å‡ºå¹¶è¿›è¡Œå‚æ•°é…ç½®
    .type = DRIVER_WS2812,
    .driver_conf.ws2812.led_num = 22,
    .driver_conf.ws2812.ctrl_io = 4,

    //2. é©±åŠ¨åŠŸèƒ½é€‰æ‹©ï¼Œæ ¹æ®ä½ çš„éœ€è¦å¯ç”¨/ç¦ç”¨
    .capability.enable_fade = true,
    .capability.fade_time_ms = 800,
    .capability.enable_status_storage = true,

    /* å¯¹äº WS2812 åªèƒ½é€‰æ‹© LED_BEADS_3CH_RGB */
    .capability.led_beads = LED_BEADS_3CH_RGB,
    .capability.storage_cb = NULL,

    //3. é™åˆ¶å‚æ•°ï¼Œä½¿ç”¨ç»†åˆ™è¯·å‚è€ƒåé¢å°èŠ‚
    .external_limit = NULL,

    //4. é¢œè‰²æ ¡å‡†å‚æ•°
    .gamma_conf = NULL,

    //5. åˆå§‹åŒ–ç…§æ˜å‚æ•°ï¼Œå¦‚æœ on ç½®ä½å°†åœ¨åˆå§‹åŒ–é©±åŠ¨æ—¶ç‚¹äº®çƒæ³¡ç¯
    .init_status.mode = WORK_COLOR,
    .init_status.on = true,
    .init_status.hue = 0,
    .init_status.saturation = 100,
    .init_status.value = 100,
};
lightbulb_init(&config);
```

## é™åˆ¶å‚æ•°ä½¿ç”¨è¯´æ˜

é™åˆ¶å‚æ•°ä¸»è¦ç”¨é€”ä¸ºé™åˆ¶è¾“å‡ºçš„æœ€å¤§åŠŸç‡ï¼Œä»¥åŠå°†äº®åº¦å‚æ•°é™åˆ¶åœ¨ä¸€ä¸ªåŒºé—´ã€‚è¯¥ç»„ä»¶å½©å…‰ä¸ç™½å…‰å¯ç‹¬ç«‹æ§åˆ¶ï¼Œæ‰€ä»¥å­˜åœ¨ 2 ç»„æœ€å¤§/æœ€å°äº®åº¦å‚æ•°åŠåŠŸç‡å‚æ•°ã€‚å½©å…‰ä½¿ç”¨ `HSV` æ¨¡å‹ï¼Œ`value` ä»£è¡¨å½©å…‰äº®åº¦ï¼Œç™½å…‰ä½¿ç”¨ `brightness` å‚æ•°ã€‚`value` ä¸ `brightness` æ•°æ®è¾“å…¥èŒƒå›´ä¸º 0 <= x <= 100ã€‚

å¦‚æœè®¾ç½®äº†äº®åº¦é™åˆ¶å‚æ•°ï¼Œé‚£ä¹ˆå°†å¯¹è¾“å…¥å€¼è¿›è¡Œç­‰æ¯”ä¾‹ç¼©æ”¾ï¼Œä¾‹å¦‚ï¼Œæˆ‘ä»¬è®¾ç½®äº†ä¸‹é¢è¿™äº›å‚æ•°

```c
lightbulb_power_limit_t limit = {
    .white_max_brightness = 100,
    .white_min_brightness = 10,
    .color_max_value = 100,
    .color_min_value = 10,
    .white_max_power = 100,
    .color_max_power = 100
}
```

`value` ä¸ `brightness` è¾“å…¥ä¸è¾“å‡ºçš„å…³ç³»å¦‚ä¸‹ï¼š

```c
input   output
100      100
80       82
50       55
11       19
1        10
0        0
```

åŠŸç‡é™åˆ¶åœ¨äº®åº¦å‚æ•°é™åˆ¶åè¿›ä¸€æ­¥è¿›è¡Œï¼Œå¯¹äº RGB é€šé“è°ƒæ•´åŒºé—´ä¸º 100 <= x <= 300ï¼Œè¾“å…¥ä¸è¾“å‡ºçš„å…³ç³»å¦‚ä¸‹ï¼š

```c
input           output(color_max_power = 100)       output(color_max_power = 200)       output(color_max_power = 300)
255,255,0       127,127,0                           255,255,0                           255,255,0
127,127,0       63,63,0                             127,127,0                           127,127,0
63,63,0         31,31,0                             63,63,0                             63,63,0
255,255,255     85,85,85                            170,170,170                         255,255,255
127,127,127     42,42,42                            84,84,84                            127,127,127
63,63,63        21,21,21                            42,42,42                            63,63,63

```

## é¢œè‰²æ ¡å‡†å‚æ•°

é¢œè‰²æ ¡å‡†å‚æ•°ç”± 2 ä¸ªéƒ¨åˆ†ç»„æˆï¼Œç”¨äºç”Ÿæˆ gamma ç°åº¦è¡¨çš„æ›²çº¿ç³»æ•° `curve_coefficient` åŠç”¨äºåšæœ€ç»ˆè°ƒæ•´çš„ç™½å¹³è¡¡ç³»æ•° `balance_coefficient`ã€‚

- æ›²çº¿ç³»æ•°çš„å–å€¼åœ¨ 0.8 <= x <= 2.2ï¼Œå„å‚æ•°è¾“å‡ºå¦‚ä¸‹

```c

   |  x = 1.0                           | x < 1.0                          | x > 1.0
max|                                    |                                  |
   |                                *   |                     *            |                           *
   |                             *      |                  *               |                          *
   |                          *         |               *                  |                         *
   |                       *            |             *                    |                       *
   |                    *               |           *                      |                     *
   |                 *                  |         *                        |                   *
   |              *                     |       *                          |                 *
   |           *                        |     *                            |              *
   |        *                           |    *                             |           * 
   |     *                              |   *                              |        *
   |  *                                 |  *                               |  *
0  |------------------------------------|----------------------------------|------------------------------   
  0               ...                255 
```

- ç™½å¹³è¡¡ç³»æ•°çš„å–å€¼åœ¨ 0.5-1.0ï¼Œå¯¹æ•°æ®è¿›è¡Œæœ€åå¾®è°ƒï¼Œè®¡ç®—è§„åˆ™ä¸º `è¾“å‡ºå€¼ = è¾“å…¥å€¼ * ç³»æ•°`ï¼Œå¯ä»¥ä¸ºæ¯ä¸ªé€šé“è®¾ç½®ä¸åŒçš„ç³»æ•°ã€‚

## ç¤ºä¾‹ä»£ç 

[ç‚¹å‡»æ­¤å¤„](https://github.com/espressif/esp-iot-solution/tree/master/examples/lighting/lightbulb) è·å–ç¤ºä¾‹ä»£ç åŠä½¿ç”¨è¯´æ˜ã€‚
